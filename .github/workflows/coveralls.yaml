name: Test Coverage with Coveralls

on:
  push:
  pull_request:

jobs:
  test-coverage:
    name: Run Tests and Upload Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.platformio/packages
            ~/.platformio/platforms
          key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-platformio-

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Install coverage tools
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov gcovr

      - name: Run Unity tests with coverage (native2 environment)
        run: |
          pio test -e native2 --verbose
        continue-on-error: false

      - name: Generate coverage report
        run: |
          # Find all .gcda files and generate coverage
          find . pio/build/native2 -name "*.gcda" -type f || echo "No .gcda files found"
          
          # Generate lcov coverage data - capture ALL data first
          lcov --capture \
               --directory .pio/build/native2 \
               --base-directory . \
               --output-file coverage.info \
               --rc lcov_branch_coverage=1 \
               --ignore-errors source || echo "lcov capture failed, trying gcovr..."
          
          # If lcov fails or produces empty file, try gcovr as fallback
          if [ ! -s coverage.info ]; then
            echo "lcov failed, using gcovr instead"
            gcovr --root . \
                  --filter 'src/core/.*' \
                  --exclude 'test/.*' \
                  --exclude '.pio/.*' \
                  --exclude 'unity.*' \
                  --lcov coverage.info \
                  --gcov-ignore-errors=no_working_dir_found
          fi
          
          # Filter out unwanted files (only if coverage.info has content)
          if [ -s coverage.info ]; then
            lcov --remove coverage.info \
                 '*/test/*' \
                 '*/.pio/build/*/unity*' \
                 '*/lib/*' \
                 '/usr/*' \
                 --output-file coverage_filtered.info \
                 --ignore-errors unused || cp coverage. info coverage_filtered.info
          fi

      - name: Display coverage summary
        run: |
          if [ -f coverage_filtered.info ]; then
            lcov --list coverage_filtered.info
          else
            echo "No coverage file generated"
            # Create empty coverage file for Coveralls
            echo "TN:" > coverage_filtered.info
            echo "end_of_record" >> coverage_filtered.info
          fi

      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: coverage_filtered.info
          flag-name: unity-tests
        continue-on-error: true
